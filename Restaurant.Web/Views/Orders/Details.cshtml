@model Restaurant.Domain.Entities.Order
@using Restaurant.Domain.Enums

@{
    ViewData["Title"] = "Order Details";

    var badge = Model.Status switch
    {
        OrderStatus.Pending => "text-bg-secondary",
        OrderStatus.Preparing => "text-bg-warning",
        OrderStatus.OutForDelivery => "text-bg-info",
        OrderStatus.Delivered => "text-bg-success",
        OrderStatus.Cancelled => "text-bg-danger",
        _ => "text-bg-secondary"
    };

    var icon = Model.Status switch
    {
        OrderStatus.Pending => "bi-hourglass-split",
        OrderStatus.Preparing => "bi-fire",
        OrderStatus.OutForDelivery => "bi-truck",
        OrderStatus.Delivered => "bi-check-circle",
        OrderStatus.Cancelled => "bi-x-circle",
        _ => "bi-circle"
    };

    var items = Model.Items ?? Enumerable.Empty<Restaurant.Domain.Entities.OrderItem>();
    var total = items.Sum(i => i.UnitPrice * i.Quantity);

    var steps = new[] { OrderStatus.Pending, OrderStatus.Preparing, OrderStatus.OutForDelivery, OrderStatus.Delivered };
    var currentIndex = Array.IndexOf(steps, Model.Status);
    var isCancelled = Model.Status == OrderStatus.Cancelled;

    int StepIndex(OrderStatus s) => Array.IndexOf(steps, s);

    string StepState(OrderStatus s)
    {
        if (isCancelled) return "step-disabled";
        if (currentIndex == -1) return "step-disabled"; // e.g. cancelled
        var idx = StepIndex(s);
        if (idx < currentIndex) return "step-done";
        if (idx == currentIndex) return "step-current";
        return "step-todo";
    }
}

<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <div>
        <h2 class="mb-1 fw-semibold">Order Details</h2>
        <div class="text-muted small">Order #@Model.Id.ToString().Substring(0, 8)</div>
    </div>

    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary rounded-pill" asp-action="Index">
            <i class="bi bi-arrow-left me-1"></i>Back
        </a>

        @if (Model.Status != OrderStatus.Delivered && Model.Status != OrderStatus.Cancelled)
        {
            <a class="btn btn-outline-warning rounded-pill"
               asp-action="EditStatus"
               asp-route-id="@Model.Id">
                <i class="bi bi-arrow-repeat me-1"></i>Change Status
            </a>
        }
    </div>
</div>

<div class="row g-3">
    <div class="col-12 col-lg-5">
        <div class="card border-0 shadow-sm rounded-4 mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small">Customer</div>
                        <div class="fs-5 fw-semibold">@Model.CustomerName</div>
                    </div>

                    <span class="badge rounded-pill @badge">
                        <i class="bi @icon me-1"></i>@Model.Status
                    </span>
                </div>

                <hr class="my-3" />

                <div class="d-flex flex-column gap-2">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Phone</span>
                        <span class="fw-semibold">@Model.Phone</span>
                    </div>

                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Address</span>
                        <span class="fw-semibold text-end">@Model.DeliveryAddress</span>
                    </div>

                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Created</span>
                        <span class="fw-semibold">@Model.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</span>
                    </div>
                </div>

                <div class="mt-3 p-3 rounded-4 bg-light border">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Total</span>
                        <span class="fs-4 fw-semibold">$@total.ToString("0.00")</span>
                    </div>
                    <div class="text-muted small mt-1">Calculated from items</div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold"><i class="bi bi-diagram-3 me-2"></i>Order progress</h5>
                    @if (isCancelled)
                    {
                        <span class="badge rounded-pill text-bg-danger">Cancelled</span>
                    }
                </div>

                <div class="steps">
                    <div class="step @StepState(OrderStatus.Pending)">
                        <div class="step-dot"><i class="bi bi-hourglass-split"></i></div>
                        <div class="step-label">Pending</div>
                    </div>

                    <div class="step @StepState(OrderStatus.Preparing)">
                        <div class="step-dot"><i class="bi bi-fire"></i></div>
                        <div class="step-label">Preparing</div>
                    </div>

                    <div class="step @StepState(OrderStatus.OutForDelivery)">
                        <div class="step-dot"><i class="bi bi-truck"></i></div>
                        <div class="step-label">Out</div>
                    </div>

                    <div class="step @StepState(OrderStatus.Delivered)">
                        <div class="step-dot"><i class="bi bi-check-circle"></i></div>
                        <div class="step-label">Delivered</div>
                    </div>
                </div>

                <div class="steps-line"></div>

                <div class="text-muted small mt-3">
                    @if (isCancelled)
                    {
                        <span>This order was cancelled.</span>
                    }
                    else
                    {
                        <span>Current status: <strong>@Model.Status</strong></span>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-7">
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-semibold"><i class="bi bi-bag-check me-2"></i>Items</h5>
                </div>

                @if (!items.Any())
                {
                    <div class="text-muted">No items in this order.</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-3" style="width:90px;">Image</th>
                                    <th>Item</th>
                                    <th style="width:110px;">Qty</th>
                                    <th style="width:120px;">Unit</th>
                                    <th class="text-end pe-3" style="width:140px;">Line</th>
                                </tr>
                            </thead>
                            <tbody>
@foreach (var i in items)
{
    var line = i.UnitPrice * i.Quantity;
    var name = i.MenuItem?.Name ?? i.MenuItemId.ToString();
    var img = i.MenuItem?.ImageUrl;

    <tr>
        <td class="ps-3">
            <a class="thumb-wrapper thumb-link"
               asp-controller="MenuItems"
               asp-action="Details"
               asp-route-id="@i.MenuItemId"
               title="View item details">
                <img class="menu-thumb"
                     src="@(string.IsNullOrWhiteSpace(img) ? "https://via.placeholder.com/128x128?text=Food" : img)"
                     alt="@name"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/128x128?text=No+Image';" />
            </a>
        </td>

        <td>
            <a class="fw-semibold text-decoration-none item-link"
               asp-controller="MenuItems"
               asp-action="Details"
               asp-route-id="@i.MenuItemId">
                @name
            </a>
            <div class="text-muted small">View details</div>
        </td>

        <td>@i.Quantity</td>
        <td>$@i.UnitPrice.ToString("0.00")</td>
        <td class="text-end pe-3 fw-semibold">$@line.ToString("0.00")</td>
    </tr>
}
</tbody>

                        </table>
                    </div>

                    <div class="d-flex justify-content-end mt-3">
                        <div class="p-3 rounded-4 bg-white border shadow-sm" style="min-width: 280px;">
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Subtotal</span>
                                <span class="fw-semibold">$@total.ToString("0.00")</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span class="text-muted">Delivery</span>
                                <span class="fw-semibold">$0.00</span>
                            </div>
                            <hr class="my-2" />
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Total</span>
                                <span class="fs-5 fw-semibold">$@total.ToString("0.00")</span>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="card-footer bg-white border-0 pt-0 pb-3 px-3">
                <div class="d-flex justify-content-end">
                    <a class="btn btn-outline-secondary rounded-pill" asp-action="Index">
                        <i class="bi bi-arrow-left me-1"></i>Back to Orders
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

